<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fisiomasso - Funcion√°rios</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { background: #f0f4f8; font-family: 'Inter', sans-serif; }
h1 { color: #1e293b; }
.card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 12px 25px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 18px 35px rgba(0,0,0,0.15); }
.filter-container { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
.filter-container select, .filter-container input { flex:1; padding:12px; border-radius:12px; border: 1px solid #cbd5e1; transition: all 0.3s; }
.filter-container select:focus, .filter-container input:focus { outline:none; border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
.navbar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
.navbar button { flex: 1; padding: 14px; font-weight: 600; border-radius: 12px; border: none; transition: 0.3s; background: linear-gradient(135deg,#0ea5e9,#3b82f6); color: white; }
.navbar button:hover { background: linear-gradient(135deg,#3b82f6,#0ea5e9); transform: scale(1.05); }
.status-pendente { background: linear-gradient(90deg,#fde68a,#fcd34d); color:#92400e; }
.status-confirmado { background: linear-gradient(90deg,#bbf7d0,#22c55e); color:#166534; }
.status-cancelado { background: linear-gradient(90deg,#fecaca,#ef4444); color:#991b1b; }
.tooltip { position: relative; display: inline-block; cursor: pointer; }
.tooltip .tooltiptext { visibility: hidden; width: max-content; background-color: #1e293b; color: #fff; text-align: center; border-radius: 6px; padding: 6px 10px; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); opacity:0; transition: opacity 0.3s; font-size:0.875rem; }
.tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
.fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
@keyframes fadeIn { to { opacity: 1; } }
</style>
</head>
<body class="p-6 md:p-12">

<h1 class="text-4xl font-bold mb-8">Fisiomasso - Painel Funcion√°rios</h1>

<!-- Dashboard de status -->
<div class="grid md:grid-cols-3 gap-6 mb-8">
  <div class="card text-center"><h2 class="text-gray-500">Total</h2><p id="total" class="text-3xl font-bold">0</p></div>
  <div class="card text-center"><h2 class="text-gray-500">Pendentes</h2><p id="pendentes" class="text-3xl font-bold text-yellow-500">0</p></div>
  <div class="card text-center"><h2 class="text-gray-500">Confirmados</h2><p id="confirmados" class="text-3xl font-bold text-green-600">0</p></div>
</div>

<!-- Filtros premium -->
<div class="filter-container">
  <select id="funcionarioSelect" class="shadow-lg"></select>
  <input type="date" id="dataFiltro" class="shadow-lg">
</div>

<!-- Navbar premium de funcion√°rios -->
<div class="navbar" id="funcionariosNavbar"></div>

<!-- Cards de agendamentos -->
<div id="cardsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCWJZiUilkri_oCN4rLvmqFV5H_GhvEd6E",
  authDomain: "fisioterapia-agendamento.firebaseapp.com",
  projectId: "fisioterapia-agendamento",
  storageBucket: "fisioterapia-agendamento.appspot.com",
  messagingSenderId: "928899499645",
  appId: "1:928899499645:web:e86a365a71c85f845c1314"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let funcionarios = [];
let agendamentos = [];

const funcionarioSelect = document.getElementById("funcionarioSelect");
const dataFiltro = document.getElementById("dataFiltro");
const cardsContainer = document.getElementById("cardsContainer");
const funcionariosNavbar = document.getElementById("funcionariosNavbar");

function formatarData(dataStr) {
  if (!dataStr) return "-";
  const d = new Date(dataStr);
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

onAuthStateChanged(auth, async (user) => {
  if(!user) { window.location.href="login.html"; return; }

  // Verifica admin
  const adminSnap = await getDocs(collection(db,"admins"));
  if(!adminSnap.docs.find(d=>d.id===user.uid)) { alert("Voc√™ n√£o tem permiss√£o."); return; }

  await carregarFuncionarios();
  await carregarAgendamentos();
});

async function carregarFuncionarios() {
  const snap = await getDocs(collection(db,"funcionarios"));
  funcionarios = snap.docs.map(d=>({id:d.id, nome:d.data().nome}));

  funcionarioSelect.innerHTML = '<option value="">Todos os funcion√°rios</option>';
  funcionarios.forEach(f=>{
    funcionarioSelect.innerHTML += `<option value="${f.nome}">${f.nome}</option>`;
  });

  // Navbar
  funcionariosNavbar.innerHTML = '';
  funcionarios.forEach(f=>{
    const btn = document.createElement('button');
    btn.innerText = f.nome;
    btn.onclick = ()=>{ funcionarioSelect.value=f.nome; renderCards(); };
    funcionariosNavbar.appendChild(btn);
  });
}

dataFiltro.addEventListener('change', renderCards);
funcionarioSelect.addEventListener('change', renderCards);

async function carregarAgendamentos() {
  const snap = await getDocs(collection(db,"agendamentos"));
  agendamentos = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderCards();
}

function renderCards() {
  const filtroFuncionario = funcionarioSelect.value;
  const filtroData = dataFiltro.value;

  let filtered = agendamentos.filter(a=>{
    let ok = true;
    if(filtroFuncionario) ok = ok && a.funcionario===filtroFuncionario;
    if(filtroData) ok = ok && a.data===filtroData;
    return ok;
  });

  // Ordena por data + hor√°rio crescente
  filtered.sort((a,b)=>{
    const dtA = new Date(`${a.data}T${a.horario || '00:00'}`);
    const dtB = new Date(`${b.data}T${b.horario || '00:00'}`);
    return dtA - dtB;
  });

  cardsContainer.innerHTML = '';
  let total=0, pendentes=0, confirmados=0;

  filtered.forEach(a=>{
    total++;
    if(a.status==='pendente') pendentes++;
    if(a.status==='confirmado') confirmados++;

    const statusClasses = a.status==='confirmado' ? 'status-confirmado' :
                          a.status==='cancelado' ? 'status-cancelado' : 'status-pendente';

    const card = document.createElement('div');
    card.className = 'card fade-in';

    card.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-xl font-semibold text-gray-800">${a.nomeCompleto||"-"}</h3>
        <span class="px-3 py-1 rounded-full font-semibold ${statusClasses}">
          ${a.status==='confirmado'?'‚úÖ Confirmado':a.status==='cancelado'?'‚ùå Cancelado':'üü° Pendente'}
        </span>
      </div>
      <div class="mb-2 text-gray-600"><i class="fas fa-calendar-day text-blue-500"></i> ${formatarData(a.data)} | <i class="fas fa-clock text-blue-500"></i> ${a.horario||"-"}</div>
      <div class="flex flex-col gap-1">
        <div class="tooltip"><i class="fab fa-whatsapp text-green-500"></i> ${a.whatsapp||"-"}<span class="tooltiptext">WhatsApp do cliente</span></div>
        <div class="tooltip"><i class="fas fa-spa text-purple-500"></i> ${a.servico||"-"}<span class="tooltiptext">Servi√ßo agendado</span></div>
      </div>
      <div class="flex gap-2 mt-4">
        <button onclick="confirmar('${a.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl transition flex justify-center items-center gap-2">
          <i class="fas fa-check"></i> Confirmar
        </button>
        <button onclick="cancelar('${a.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl transition flex justify-center items-center gap-2">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    `;
    cardsContainer.appendChild(card);
  });

  document.getElementById("total").innerText = total;
  document.getElementById("pendentes").innerText = pendentes;
  document.getElementById("confirmados").innerText = confirmados;
}

window.confirmar = async function(id) {
  await updateDoc(doc(db,"agendamentos",id),{status:'confirmado'});
  await carregarAgendamentos();
}

window.cancelar = async function(id) {
  await updateDoc(doc(db,"agendamentos",id),{status:'cancelado'});
  await carregarAgendamentos();
}
</script>
</body>
</html>