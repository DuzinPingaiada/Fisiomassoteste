<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√Årea do Funcion√°rio</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background:
    radial-gradient(circle at 15% 20%, rgba(59,130,246,0.15), transparent 40%),
    radial-gradient(circle at 85% 80%, rgba(16,185,129,0.12), transparent 40%),
    linear-gradient(to bottom right, #0f172a, #020617);
  background-attachment: fixed;
}

/* Glow suave */
body::before {
  content: "";
  position: fixed;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(99,102,241,0.15), transparent 70%);
  top: -200px;
  right: -200px;
  filter: blur(120px);
  z-index: 0;
}

/* Scroll refinado */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #334155, #1e293b);
  border-radius: 10px;
}
::-webkit-scrollbar-thumb:hover { background: #475569; }

/* Transi√ß√µes globais */
button, select, input, div {
  transition: all .25s ease;
}
</style>
</head>

<body class="relative min-h-screen text-slate-100 p-5 md:p-10">

<!-- LOGIN -->
<div id="loginArea" class="flex items-center justify-center h-screen relative z-10">
  <div class="backdrop-blur-2xl bg-white/5 p-12 rounded-[32px] shadow-[0_20px_80px_rgba(0,0,0,0.7)] w-full max-w-md border border-white/10">

    <h2 class="text-3xl font-bold mb-10 text-center tracking-wide">
      üîê √Årea do Funcion√°rio
    </h2>

    <label for="email" class="sr-only">Email</label>
    <input 
      id="email"
      name="email"
      type="email"
      placeholder="Email"
      autocomplete="email"
      class="w-full mb-5 p-4 rounded-2xl bg-slate-100 text-black focus:ring-2 focus:ring-indigo-500 outline-none">

    <label for="password" class="sr-only">Senha</label>
    <input 
      id="password"
      name="password"
      type="password"
      placeholder="Senha"
      autocomplete="current-password"
      class="w-full mb-8 p-4 rounded-2xl bg-slate-100 text-black focus:ring-2 focus:ring-indigo-500 outline-none">

    <button onclick="login()"
      class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:scale-[1.02] active:scale-[0.98] p-4 rounded-2xl font-semibold shadow-xl">
      Entrar
    </button>

    <p id="loginError" class="text-red-400 mt-6 text-center"></p>
  </div>
</div>

<!-- AGENDA -->
<div id="agendaArea" class="hidden max-w-7xl mx-auto relative z-10">

  <!-- HEADER -->
  <div class="flex flex-col md:flex-row justify-between md:items-center gap-6 mb-14">
    <h1 class="text-4xl md:text-5xl font-bold tracking-tight">
      üìÖ Agenda Fisisiomasso
    </h1>

    <button onclick="logout()"
      class="bg-gradient-to-r from-red-600 to-red-800 hover:scale-[1.05] active:scale-[0.95] px-7 py-3 rounded-2xl shadow-xl font-semibold">
      Sair
    </button>
  </div>

  <!-- FILTROS -->
  <div class="backdrop-blur-2xl bg-white/5 p-10 rounded-[32px] shadow-[0_20px_80px_rgba(0,0,0,0.6)] mb-14 grid md:grid-cols-2 gap-10 border border-white/10">

    <div>
      <label for="funcionario" class="sr-only">Funcion√°rio</label>
      <select 
        id="funcionario"
        name="funcionario"
        autocomplete="off"
        class="w-full p-4 rounded-2xl bg-slate-100 text-black focus:ring-2 focus:ring-indigo-500 outline-none">
      </select>
    </div>

    <div>
      <label for="data" class="sr-only">Data</label>
      <input 
        type="date"
        id="data"
        name="data"
        autocomplete="off"
        class="w-full p-4 rounded-2xl bg-slate-100 text-black focus:ring-2 focus:ring-indigo-500 outline-none">
    </div>

  </div>

  <!-- AGENDA -->
  <div id="agenda"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  onSnapshot,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCWJZiUilkri_oCN4rLvmqFV5H_GhvEd6E",
  authDomain: "fisioterapia-agendamento.firebaseapp.com",
  projectId: "fisioterapia-agendamento",
  storageBucket: "fisioterapia-agendamento.appspot.com",
  messagingSenderId: "928899499645",
  appId: "1:928899499645:web:e86a365a71c85f845c1314"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginArea = document.getElementById("loginArea");
const agendaArea = document.getElementById("agendaArea");
const funcionarioSelect = document.getElementById("funcionario");
const dataInput = document.getElementById("data");
const agendaDiv = document.getElementById("agenda");

let agendamentos = [];
let unsubscribe = null;

dataInput.valueAsDate = new Date();

window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch {
    document.getElementById("loginError").innerText = "Email ou senha inv√°lidos";
  }
}

window.logout = async function() {
  await signOut(auth);
}

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    loginArea.classList.remove("hidden");
    agendaArea.classList.add("hidden");
    if (unsubscribe) unsubscribe();
    return;
  }

  const adminSnap = await getDocs(collection(db,"admins"));
  if(!adminSnap.docs.find(d=>d.id===user.uid)){
    alert("Sem permiss√£o.");
    await signOut(auth);
    return;
  }

  loginArea.classList.add("hidden");
  agendaArea.classList.remove("hidden");

  carregarFuncionarios();
  carregarAgendamentos();
});

async function carregarFuncionarios() {
  const snap = await getDocs(collection(db,"funcionarios"));
  funcionarioSelect.innerHTML = snap.docs.map(d =>
    `<option value="${d.data().nome}">${d.data().nome}</option>`
  ).join('');
}

function carregarAgendamentos(){
  if(unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(collection(db,"agendamentos"), snap=>{
    agendamentos = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderAgenda();
  });
}

function renderAgenda(){

  if (!dataInput.value || !funcionarioSelect.value) {
    agendaDiv.innerHTML = "";
    return;
  }

  const funcionario = funcionarioSelect.value.trim().toLowerCase();
  const data = dataInput.value;

  const partes = data.split("-");
  const ano = parseInt(partes[0]);
  const mes = parseInt(partes[1]) - 1;
  const dia = parseInt(partes[2]);

  const dataLocal = new Date(ano, mes, dia);
  const diaSemana = dataLocal.getDay();

  let horarios;

  if (diaSemana === 5) {
    horarios = ["08:00","09:00","10:00","11:00","15:00","16:00","17:00","18:00"];
  } else {
    horarios = ["08:00","09:00","10:00","11:00","15:00","16:00","17:00","18:00","19:00"];
  }

  agendaDiv.innerHTML = `
    <div class="backdrop-blur-2xl bg-white/5 rounded-[32px] shadow-[0_20px_80px_rgba(0,0,0,0.7)] overflow-hidden border border-white/10">
      <div id="agendaGrid"></div>
    </div>
  `;

  const grid = document.getElementById("agendaGrid");

  horarios.forEach(horario=>{

    const ag = agendamentos.find(a=>
      a.funcionario?.trim().toLowerCase()===funcionario &&
      a.data===data &&
      a.horario===horario &&
      a.status==="confirmado"
    );

    const row = document.createElement("div");
    row.className = "grid grid-cols-1 md:grid-cols-[120px_1fr] border-t border-white/5 hover:bg-white/5";

    const horaCol = document.createElement("div");
    horaCol.className = "p-6 font-bold text-slate-400 md:text-center bg-black/20";
    horaCol.innerText = horario;

    const conteudo = document.createElement("div");
    conteudo.className = "p-6";

    if(ag){
      conteudo.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 
        bg-gradient-to-br from-rose-600 to-red-800 
        p-8 rounded-[28px] shadow-[0_15px_50px_rgba(0,0,0,0.6)] 
        hover:scale-[1.02]">

          <div class="space-y-2">
            <p class="font-bold text-2xl">${ag.nomeCompleto}</p>
            <p class="text-red-200">${ag.servico}</p>
            <a href="https://wa.me/55${ag.whatsapp}" 
               target="_blank" 
               class="underline text-sm break-all">
              üì± ${ag.whatsapp}
            </a>
          </div>

          <button onclick="concluir('${ag.id}')"
            class="bg-black/30 hover:bg-black/50 px-6 py-3 rounded-2xl font-semibold">
            Finalizado
          </button>

        </div>
      `;
    } else {
      conteudo.innerHTML = `
        <div class="bg-gradient-to-br from-emerald-500 to-green-700 
        p-8 rounded-[28px] text-center font-semibold shadow-xl text-lg 
        hover:scale-[1.02]">
          Dispon√≠vel
        </div>
      `;
    }

    row.appendChild(horaCol);
    row.appendChild(conteudo);
    grid.appendChild(row);
  });
}

window.concluir = async function(id){
  await deleteDoc(doc(db,"agendamentos",id));
}

funcionarioSelect.addEventListener("change",renderAgenda);
dataInput.addEventListener("change",renderAgenda);

</script>
</body>
</html>